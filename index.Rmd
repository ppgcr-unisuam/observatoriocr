---
title: OBSERVATÓRIO CR

output:
  html_document:
    toc: false
---

<!--CUSTOM SCRIPTS FOR THIS PAGE ONLY-->

<!--script for background color-->
<style>
body {
  background-color: #2C3E50 !important;
  color: white;
  }
</style>

<!--script for hover effect on table-->
<style>
.table-hover > tbody > tr:hover { 
  background-color: #18BC9C;
  }
</style>

<!--script for removing background shading of carousel controls-->
<style>
.carousel-control.left, .carousel-control.right {
   background-image:none !important;
   filter:none !important;
   }
</style>

```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# create a new code chunk and then use the PACKUP add-in to generate this code with all the required libraries for this Rmd
library(bsplus)
library(cowplot)
library(dplyr)
library(geobr)
library(ggplot2)
library(ggpubr)
library(grid)
library(gridExtra)
library(gtsummary)
library(htmlwidgets)
library(igraph)
library(kableExtra)
library(knitr)
library(magrittr)
library(RColorBrewer)
library(readxl)
library(Rmisc)
library(sf)
library(tm)
library(viridis)
library(webshot2)
library(wordcloud2)
```

## {#observatoriocr}

<br>

<br>

<center>
[<img align="center" src="Images/coruja.png">](https://www.unisuam.edu.br){target="_blank"}

<br>

<br>

<p style = "font-size:1.5em">
O **OBSERVATÓRIO CR** é uma iniciativa do **Programa de Pós-graduação em Ciências da Reabilitação** do [Centro Universitário Augusto Motta](http://www.unisuam.edu.br) que envolve o registro, o acompanhamento, a análise agregada e estruturada de dados para divulgação transparente de suas atividades, planejamentos, ações e impactos, tornando-os acessíveis à sociedade.
</p>
</center>

<br>

<br>

## {#tematicas}

```{r sintese-temas, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "hide", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# file path to save the wordclouds
dir.path <- file.path(getwd(), "index_files", "figure-html")
dir.create(dir.path, recursive = TRUE)

# projetos
sheet <- "Projetos"
source("Scripts/read_sucupira.R")
data.to.cloud <- sucupira.raw$`Nome do Projeto de Pesquisa`
cloud.title <- "Projetos de Pesquisa"
source("Scripts/docs_to_wordcloud.R")

# dissertações e teses
sheet <- "TCC"
source("Scripts/read_sucupira.R")
data.to.cloud <- sucupira.raw$`Nome do Trabalho de Conclusão`
cloud.title <- "Dissertações e Teses"
source("Scripts/docs_to_wordcloud.R")

# artigos
sheet <- "Produções"
source("Scripts/read_sucupira.R")
data.to.cloud <- sucupira.raw$`Nome da Produção`
cloud.title <- "Produção Bibliográfica"
source("Scripts/docs_to_wordcloud.R")
```

```{r sintese-temas-wordcloud, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# carousel of wordclouds
bs_carousel(id = "wordcloud",
            use_indicators = TRUE,
            use_controls = TRUE) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/Projetos.png")) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/TCC.png")) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/Produções.png"))
```

<br>

<br>

## {#projetos-linha}

```{r sintese-projetos, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "hide", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# projetos - membros
sheet <- "Projetos - Membros"
source("Scripts/read_sucupira.R")
projetos.list <- sucupira.list

# list all available years
anos <-
  as.numeric(list.dirs(
    file.path(getwd(), "Sucupira"),
    recursive = FALSE,
    full.names = FALSE
  ))

# get all history of 'linha de pesquisa'
linhas <- na.exclude(unique(sucupira.raw$`Linha de Pesquisa`))

# initialize data structure
andamento.ano <-
  matrix(NA, nrow = length(linhas), ncol = length(anos))
colnames(andamento.ano) <- anos
rownames(andamento.ano) <- linhas
concluido.ano <- andamento.ano

# iterate across all Sucupira list elements to search for active and closed projects
for (i in 1:length(anos)) {
  projetos <- projetos.list[[i]]
  projetos <-
    projetos[projetos$`Membro Responsável` == "Sim" &
               projetos$Situação == "EM ANDAMENTO",]
  for (j in 1:length(linhas)) {
    andamento.ano[j, i] <-
      sum(projetos$`Linha de Pesquisa` == linhas[j], na.rm = TRUE)
  }
  projetos <- projetos.list[[i]]
  projetos <-
    projetos[projetos$`Membro Responsável` == "Sim" &
               projetos$Situação == "CONCLUÍDO",]
  for (j in 1:length(linhas)) {
    concluido.ano[j, i] <-
      sum(projetos$`Linha de Pesquisa` == linhas[j], na.rm = TRUE)
  }
}
projetos.ano <- andamento.ano + concluido.ano
projetos.ano <-
  projetos.ano[, order(colnames(projetos.ano), decreasing = FALSE)]

# get only current 'linha de pesquisa'
linhas.curr <-
  na.exclude(unique(sucupira.list[[length(anos)]]$`Linha de Pesquisa`))
col.curr <- match(linhas.curr, linhas)

# plot area setup
par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

# generate plot of projetos per linha by year (absolute frequency)
barplot(projetos.ano,
        ylab = "N",
        col = brewer.pal(n = length(linhas), name = "Set3"))
title(main = "Projetos por Linha de Pesquisa", outer = TRUE, cex.main = 1.7)
legend(
  "topright",
  legend = linhas.curr,
  fill = brewer.pal(n = length(linhas), name = "Set3")[col.curr],
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 0.5,
)

# generate plot of projetos per linha by year (relative frequency)
barplot(
  scale(
    as.matrix(projetos.ano),
    center = FALSE,
    scale = colSums(as.matrix(projetos.ano))
  ) * 100,
  ylab = "%",
  col = brewer.pal(n = length(linhas), name = "Set3"),
  ylim = c(0, 100)
)
title(main = "Projetos por Linha de Pesquisa", outer = TRUE, cex.main = 1.7)
```

```{r sintese-projetos-barplot, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# carousel of barplots
bs_carousel(id = "barplot-projetos",
            use_indicators = TRUE,
            use_controls = TRUE) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/sintese-projetos-1.png")) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/sintese-projetos-2.png"))
```

<br>

<br>

## {#financiamentos}

```{r sintese-financiamentos, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "hide", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# for displaying large numbers
options(scipen = 10)

financiadores.raw <-
  read_excel("../PPGCR Unisuam/Financiadores.xlsx", sheet = "DADOS.fomento")

# select variables to display
financiadores <-
  financiadores.raw %>% select("Ano", "Agência", "Total", "Programa", "Proponente")

# drop rows with empty cells
financiadores <- financiadores[complete.cases(financiadores), ]

# generate cross-table
N.editais.agencia.ano <- table(financiadores$'Agência', financiadores$'Ano')
N.editais.agencia.ano <-
  N.editais.agencia.ano[, order(colnames(N.editais.agencia.ano), decreasing = FALSE)]

# get all 'agencias'
agencias <-
  na.exclude(rownames(N.editais.agencia.ano))

# plot area setup
par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

# generate plot of financiamentos per agency by year (absolute frequency)
barplot(N.editais.agencia.ano,
        ylab = "N",
        col = brewer.pal(n = length(agencias), name = "Set3"))
title(main = "Editais Financiados por Agência", outer = TRUE, cex.main = 1.7)
legend(
  "topright",
  legend = agencias,
  fill = brewer.pal(n = length(agencias), name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 0.5,
)

# generate cross-table
T.editais.agencia.ano <- with(financiadores, tapply(financiadores$Total, list(financiadores$'Agência', financiadores$'Ano'), FUN= sum))

# add zero to not available values
T.editais.agencia.ano[is.na(T.editais.agencia.ano)] <- 0

T.editais.agencia.ano <-
  T.editais.agencia.ano[, order(colnames(T.editais.agencia.ano), decreasing = FALSE)]

# em milhares
T.editais.agencia.ano <- T.editais.agencia.ano/1000

# get all 'agencias'
agencias <-
  na.exclude(rownames(T.editais.agencia.ano))

# plot area setup
par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

# generate plot of financiamentos per agency by year (absolute frequency)
barplot(T.editais.agencia.ano,
        ylab = "R$, em milhares",
        col = brewer.pal(n = length(agencias), name = "Set3"))
title(main = "Valores Financiados por Agência", outer = TRUE, cex.main = 1.7)
legend(
  "topright",
  legend = agencias,
  fill = brewer.pal(n = length(agencias), name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 0.5,
)

# generate cross-table
professores.ano <-
  rowSums(table(financiadores$Ano, financiadores$Proponente) != 0)

# plot area setup
par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

# generate plot of financiamentos per agency by year (absolute frequency)
barplot(professores.ano,
        ylab = "N",
        col = rep(brewer.pal(n = 9, name = "Set3")[1], length(professores.ano))
)
title(main = "Docentes com Financiamento", outer = TRUE, cex.main = 1.7)
```

```{r sintese-financiamentos-barplot, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# carousel of barplots
bs_carousel(id = "barplot-financiamentos",
            use_indicators = TRUE,
            use_controls = TRUE) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/sintese-financiamentos-1.png")) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/sintese-financiamentos-2.png")) %>%
  bs_append(content = bs_carousel_image(src = "index_files/figure-html/sintese-financiamentos-3.png"))
```

<br>

<br>

## {#producao}

<h1> [**Produção bibliográfica**](producoes.html#bibliografica) </h1>

```{r producao, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# Step 4. Read in a CSV file into a data frame with a bunch of dois listed in one column.
dois <-
  data.frame(read_excel(
    "../PPGCR Unisuam/Produção.xlsx",
    sheet = "PI.artigos",
    col_types = c("text")
  ))

# Data cleaning
dois <- dois[complete.cases(dois$DOI),]

artigos <-
  dois[dois$Publicado.em != "Aceito" &
         dois$Publicado.em != "Submetido", ]

par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)
# generate plot of artigos per year
table.1 <- table(artigos$Publicado.em)
barplot(
  t(table.1),
  xlab = "Ano",
  ylab = "Artigos",
  col = c("lightblue"),
  bty = "n"
)
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#producao-qualidade}

<h1> [**Qualidade da produção, por estrato**](producoes.html#bibliografica) </h1>

```{r producao-qualidade, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# Step 4. Read in a CSV file into a data frame with a bunch of dois listed in one column.
dois <-
  data.frame(read_excel(
    "../PPGCR Unisuam/Produção.xlsx",
    sheet = "PI.artigos",
    col_types = c("text")
  ))

# Data cleaning
dois <- dois[complete.cases(dois$DOI),]
dois$WebQualis[dois$WebQualis == "Sem WebQualis"] <- NA

artigos <-
  dois[dois$Publicado.em != "Aceito" &
         dois$Publicado.em != "Submetido", ]
estratos <- sort(unique(artigos$WebQualis))
ano <- sort(unique(artigos$Publicado.em))
table.1 <- t(table(artigos$Publicado.em, artigos$WebQualis))
table.1 <- apply(table.1, 2, rev)

layout(matrix(
  c(1:2),
  nrow = 2,
  ncol = 1,
  byrow = TRUE
), heights = c(1 / 2, 1 / 2))
par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white"
)
# generate plot of artigos per estrato by year
barplot(
  as.matrix(table.1),
  xlab = "Ano",
  ylab = "Estrato",
  col = brewer.pal(n = length(estratos) + 1, name = "Blues"),
  xaxt = 'n'
)
barplot(
  scale(
    as.matrix(table.1),
    center = FALSE,
    scale = colSums(as.matrix(table.1))
  ) * 100,
  xlab = "Ano",
  ylab = "Proporção por estrato",
  col = brewer.pal(n = length(estratos), name = "Blues"),
  yaxt = 'n',
  legend.text = rownames(table.1),
  args.legend = list(
    x = 18,
    y = -80,
    ncol = 3,
    bty = "n",
    cex = 0.7,
    x.intersp = 0.2,
    y.intersp = 0.8
  )
)
axis(2, at = c(0, 100))
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#pessoal}

<h1> **Formação de pessoal de nível superior** </h1>

```{r egressos, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

discentes.raw <-
  read_excel("../PPGCR Unisuam/Discentes.xlsx", sheet = "DATA.discentes")
discentes <- discentes.raw[discentes.raw$`Ano Titulação` != "*", ]
mestres <- discentes[discentes$Curso == "Mestrado", ]
doutores <- discentes[discentes$Curso == "Doutorado", ]

par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)
# generate plot of titulados per year
table.1 <- table(discentes$Curso, discentes$`Ano Titulação`)
barplot(
  as.matrix(table.1),
  xlab = "Ano",
  ylab = "Titulados",
  col = c("darkblue", "lightblue"),
  bty = "n"
)
legend(
  "topleft",
  legend = levels(as.factor(discentes$Curso)),
  fill = c("darkblue", "lightblue"),
  box.lty = 0
)

cat("<br>")
cat('<hr style="height:2px;border-width:0;color:white;background-color:white">')
cat("<br>")

cat("<h1 style='text-align:center;'> **Tempo médio de titulação, por ano** </h1>  \n")

par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)
# generate plot of tempo para titulação per year
tmt.mestr.ano <-
  aggregate(
    as.numeric(mestres$`Tempo de Curso (meses)`),
    by = list(mestres$`Ano Titulação`),
    FUN = mean,
    na.rm = TRUE
  )
tmt.dout.ano <-
  aggregate(
    as.numeric(doutores$`Tempo de Curso (meses)`),
    by = list(doutores$`Ano Titulação`),
    FUN = mean,
    na.rm = TRUE
  )

plot(
  tmt.mestr.ano$Group.1,
  tmt.mestr.ano$x,
  type = "l",
  lty = 1,
  lwd = 6,
  xlab = "Ano",
  ylab = "Meses",
  col = c("lightblue"),
  ylim = c(18, 60),
  bty = "n"
)
lines(
  tmt.dout.ano$Group.1,
  tmt.dout.ano$x,
  type = "l",
  lty = 1,
  lwd = 6,
  xlab = "Ano",
  ylab = "Meses",
  col = c("darkblue"),
  ylim = c(18, 60)
)
legend(
  "topleft",
  legend = levels(as.factor(discentes$Curso)),
  col = c("darkblue", "lightblue"),
  pch = "lines",
  lwd = 6,
  box.lty = 0
)

cat("<br>")
cat('<hr style="height:2px;border-width:0;color:white;background-color:white">')
cat("<br>")

# code for html anchor from yml file
cat('<div id="egressos" class="section level2">', sep = "")
cat('<h2></h2>')
cat('<h1> [**Egressos**](pessoas.html#egressos) </h1>')

par(
  oma = c(0, 0, 0, 0),
  mar = c(0, 0, 0, 0),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

datasets <- list_geobr()$years[3]
last.update <-
  as.numeric(strsplit(datasets, ", ")[[1]][length(strsplit(datasets, ", ")[[1]]) - 1])

last.update <- 2019

states <-
  read_state(
    code_state = "all",
    year = last.update,
    simplified = TRUE,
    showProgress = FALSE
  )
states$discentes <- rep(NA, dim(states)[1])
UF <- as.data.frame(table(discentes$UF))
for (i in 1:length(UF$Var1)) {
  states$discentes[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}
p1 <- ggplot() +
  geom_sf(data = states, aes(fill = discentes), color = "grey") +
  scale_fill_distiller(
    palette = "Spectral",
    name = "Egressos, n",
    limits = c(min(0, UF$Freq), max(UF$Freq)),
    na.value = "grey"
  ) +
  theme_minimal() +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(colour = "white"),
    legend.text = element_text(colour = "white")
  ) +
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    panel.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    plot.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    panel.grid.major = element_line(colour = "transparent"),
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )

data <-
  as.data.frame(table(c(discentes$UF[discentes$UF == "RJ"], rep(
    "Outras UF", length(discentes$UF[discentes$UF != "RJ"])
  ))))
colnames(data) <- c("Regiões", "N")

p2 <- ggplot(data, aes(x = "", y = N, fill = Regiões)) +
  scale_fill_manual(values = c("darkblue", "lightblue")) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(
    legend.position = 'bottom',
    legend.title = element_blank(),
    legend.text = element_text(colour = "white")
  ) +
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    panel.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    plot.background = element_rect(fill = '#2C3E50', colour = '#2C3E50')
  )

data <- as.data.frame(table(discentes$Curso))
colnames(data) <- c("Cursos", "N")

p3 <- ggplot(data, aes(x = "", y = N, fill = Cursos)) +
  scale_fill_manual(values = c("darkblue", "lightblue")) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(
    legend.position = 'bottom',
    legend.title = element_blank(),
    legend.text = element_text(colour = "white")
  ) +
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    panel.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    plot.background = element_rect(fill = '#2C3E50', colour = '#2C3E50')
  )

g <-
  arrangeGrob(p1,
              p2,
              p3,
              layout_matrix = rbind(c(1, 2), c(1, 3)),
              widths = c(7 / 10, 3 / 10))

g2 <- ggdraw(g) +
  theme(plot.background = element_rect(fill = "#2C3E50", color = NA))

plot(g2)

cat('<p><br></p>')
cat('</div>')
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#discentes}

<h1> [**Discentes**](pessoas.html#discentes) </h1>

```{r discentes-regiao, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

discentes.raw <-
  read_excel("../PPGCR Unisuam/Discentes.xlsx", sheet = "DATA.discentes")
discentes <-
  discentes.raw[discentes.raw$`Status SAGA` == "Matriculado" |
                  discentes.raw$`Status SAGA` == "Pré-inscrito", ]

# generate plot of UF per course
datasets <- list_geobr()$years[3]
last.update <-
  as.numeric(strsplit(datasets, ", ")[[1]][length(strsplit(datasets, ", ")[[1]]) - 1])
states <-
  read_state(
    code_state = "all",
    year = last.update,
    simplified = TRUE,
    showProgress = FALSE
  )
states$discentes <- rep(NA, dim(states)[1])
UF <- as.data.frame(table(discentes$UF))
for (i in 1:length(UF$Var1)) {
  states$discentes[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}

p1 <- ggplot() +
  geom_sf(data = states, aes(fill = discentes), color = "grey") +
  scale_fill_distiller(
    palette = "Spectral",
    name = "Discentes, n",
    limits = c(min(0, UF$Freq), max(UF$Freq)),
    na.value = "grey"
  ) +
  theme_minimal() +
  theme(
    legend.position = 'bottom',
    legend.title = element_text(colour = "white"),
    legend.text = element_text(colour = "white")
  ) +
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    panel.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    plot.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    panel.grid.major = element_line(colour = "transparent"),
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )

data <-
  as.data.frame(table(c(discentes$UF[discentes$UF == "RJ"], rep(
    "Outras UF", length(discentes$UF[discentes$UF != "RJ"])
  ))))
colnames(data) <- c("Regiões", "N")

p2 <- ggplot(data, aes(x = "", y = N, fill = Regiões)) +
  scale_fill_manual(values = c("darkblue", "lightblue")) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(
    legend.position = 'bottom',
    legend.title = element_blank(),
    legend.text = element_text(colour = "white")
  ) +
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    panel.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    plot.background = element_rect(fill = '#2C3E50', colour = '#2C3E50')
  )

data <- as.data.frame(table(discentes$Curso))
colnames(data) <- c("Cursos", "N")

p3 <- ggplot(data, aes(x = "", y = N, fill = Cursos)) +
  scale_fill_manual(values = c("darkblue", "lightblue")) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme_void() +
  theme(
    legend.position = 'bottom',
    legend.title = element_blank(),
    legend.text = element_text(colour = "white")
  ) +
  theme(
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    panel.background = element_rect(fill = '#2C3E50', colour = '#2C3E50'),
    plot.background = element_rect(fill = '#2C3E50', colour = '#2C3E50')
  )

g <-
  arrangeGrob(p1,
              p2,
              p3,
              layout_matrix = rbind(c(1, 2), c(1, 3)),
              widths = c(7 / 10, 3 / 10))

g2 <- ggdraw(g) +
  theme(plot.background = element_rect(fill = "#2C3E50", color = NA))

plot(g2)
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#rede}

<h1> [**Rede de pesquisa**](pessoas.html) </h1>

```{r rede-pesquisa, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# read data and row-bind all Sucupira XLSX files
sheet <- "Projetos - Membros"
membros.raw <- c()
files.to.read <-
  list.files("../PPGCR Unisuam/Sucupira/",
             pattern = "xlsx",
             full.names = TRUE)
for (i in 1:length(files.to.read)) {
  membros.raw <-
    rbind(membros.raw, read_excel(files.to.read[i], sheet = sheet))
}

# create edge matrix
proj.id <-
  as.factor(membros.raw$`Identificador do Projeto de Pesquisa`)
n.proj <- nlevels(proj.id)
membros <- sort(unique(membros.raw$`Nome do Membro do Projeto`))
n.membros <- length(membros)
categ <- as.factor(membros.raw$`Categoria do Membro do Projeto`)
n.categ <- nlevels(categ)
edge.matrix <- matrix(NA, nrow = 0, ncol = 2)
colnames(edge.matrix) <- c("from", "to")

# loop across all projects to populate the edge matrix
for (i in 1:n.proj) {
  # get the members by project id
  membros.proj <-
    unique(membros.raw$`Nome do Membro do Projeto`[proj.id == levels(proj.id)[i]])
  # only vote for upper diagonal elements
  for (n in 1:length(membros.proj)) {
    for (m in n:length(membros.proj)) {
      if (n != m) {
        # find members
        row.n <- match(membros.proj[n], membros)
        col.m <- match(membros.proj[m], membros)
        new.edge <- cbind(membros[row.n], membros[col.m])
        # add edges
        edge.matrix <- rbind(edge.matrix, new.edge)
      }
    }
  }
}

# build the graph object
network <- graph_from_edgelist(edge.matrix, directed = FALSE)

# set member category and color
colrs <- brewer.pal(n = n.categ, name = "Set3")
for (i in 1:length(V(network))) {
  categ.id <-
    match(V(network)[[i]]$name, membros.raw$`Nome do Membro do Projeto`)
  V(network)[[i]]$categ <-
    membros.raw$`Categoria do Membro do Projeto`[categ.id]
  col.id <- match(V(network)[[i]]$categ, levels(categ))
  V(network)[i]$color <- colrs[col.id]
}

# plot it
par(
  oma = c(0, 0, 0, 0),
  mar = c(0, 0, 0, 0),
  bg = '#2C3E50',
  col.lab = "white",
  mfrow = c(1, 1)
)

plot(
  network,
  directed = FALSE,
  arrow.mode = 0,
  vertex.label = NA,
  vertex.frame.color = "darkgrey",
  vertex.size = log(degree(network, mode = "all")) * 1.2,
  edge.color = "lightgrey",
  edge.lty = "solid",
  edge.size = edge.betweenness(network),
  edge.curved = .2
)

legend(
  "bottomleft",
  legend = levels(categ),
  pch = 19,
  col = colrs,
  text.col = "white",
  bty = "n",
  horiz = FALSE,
  cex = 0.8
)
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#disciplinas}

<h1> [**Disciplinas oferecidas**](programa.html#estrutura-curricular) </h1>

```{r turmas-sintese-turmas, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

sheet <- "Turmas"
turmas.raw <- c()
files.to.read <-
  list.files("../PPGCR Unisuam/Sucupira/",
             pattern = "xlsx",
             full.names = TRUE)
for (i in 1:length(files.to.read)) {
  turmas.raw <-
    rbind(turmas.raw, read_excel(files.to.read[i], sheet = sheet))
}

# build a cross table DISCIPLINA vs. ANO
turmas.raw <-
  turmas.raw[turmas.raw$`Indicador de responsável principal` == "Sim",]
turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )
cross.table.turmas <-
  as.matrix(table(turmas.raw$`Nível do curso`, turmas.raw$`Período/Ano`))

# generate plot of total per year
par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)
# generate plot of turmas per year
barplot(
  cross.table.turmas,
  las = 2,
  ylab = "Turmas",
  main = "Quantidade de turmas",
  col = c("darkblue", "lightblue"),
  beside = TRUE,
  bty = "n"
)
legend(
  "topleft",
  legend = levels(as.factor(turmas.raw$`Nível do curso`)),
  fill = c("darkblue", "lightblue"),
  box.lty = 0
)

# line break
cat("  \n")
cat("  \n")
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#nota}

<h1> **Nota do Programa** </h1>

```{r conceitos, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

periodos.raw <-
  read_excel("../PPGCR Unisuam/Avaliação.xlsx", sheet = "Períodos")

par(
  oma = c(2, 0.1, 2, 0.1),
  mar = c(5, 4, 2, 2),
  bg = '#2C3E50',
  col.lab = "white",
  col.axis = "white",
  fg = "white"
)
# generate plot of conceitos per year
barplot(
  periodos.raw$Nota ~ periodos.raw$Período,
  xlab = "Período",
  ylab = "Nota CAPES",
  col = brewer.pal(n = length(periodos.raw$Período), name = "Set3")[1],
  ylim = c(0, 7)
)
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">

<br>

## {#fontes}

<h1> **Fontes dos dados** </h1>

```{r fontes, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', results = "asis", out.width="95%"}
options(knitr.kable.NA = '--', knitr.table.format = "html")

# read separate sheets
file.path <- "../PPGCR Unisuam/Fontes.xlsx"
tabs <- excel_sheets(file.path)

# iterate across sheets
for (j in 1:length(tabs)) {
  cat('\n\n<!-- -->\n\n')
  cat("### **", tabs[j], "**", "\n", sep = "")
  cat('\n\n<!-- -->\n\n')
  fontes <-
    read_excel(file.path, sheet = tabs[j], col_types = c("text"))
  # replace the link by a tag
  for (i in 1:dim(fontes)[1]) {
    fontes[i, 1] <- paste("**", fontes[i, 1], "**", sep = "")
    fontes[i, 3] <-
      paste("[↗️](", fontes[i, 3], '){target="_blank"}', sep = "")
  }
  # print table
  print(
    kable(fontes, align = c("l", rep(
      "c", ncol(fontes) - 2
    ), "r")) %>% kable_styling(
      bootstrap_options = c("hover", "condensed", "responsive"),
      full_width = T,
      position = "center"
    )
  )
  cat('\n\n<!-- -->\n\n')
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>⬆️</a><br>')
}
```

<br>

<hr style="height:2px;border-width:0;color:white;background-color:white">
